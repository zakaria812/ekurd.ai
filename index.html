<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus AI Pro - Intelligent Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        dark: {
                            950: '#030303',
                            900: '#0a0a0a',
                            850: '#0f0f0f',
                            800: '#151515',
                            750: '#1a1a1a',
                            700: '#1f1f1f',
                        },
                        accent: {
                            gold: '#f59e0b',
                            amber: '#d97706',
                            blue: '#3b82f6',
                            cyan: '#06b6d4',
                            purple: '#8b5cf6',
                        }
                    },
                    animation: {
                        'glow': 'glow 2s ease-in-out infinite alternate',
                        'float': 'float 6s ease-in-out infinite',
                        'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'slide-up': 'slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1)',
                        'fade-in': 'fadeIn 0.3s ease-out',
                        'scale-in': 'scaleIn 0.2s ease-out',
                    },
                    keyframes: {
                        glow: {
                            '0%': { boxShadow: '0 0 20px rgba(245, 158, 11, 0.1)' },
                            '100%': { boxShadow: '0 0 40px rgba(245, 158, 11, 0.3), 0 0 60px rgba(59, 130, 246, 0.1)' },
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        scaleIn: {
                            '0%': { transform: 'scale(0.95)', opacity: '0' },
                            '100%': { transform: 'scale(1)', opacity: '1' },
                        },
                    }
                }
            }
        }
    </script>
    
    <style>
        * { box-sizing: border-box; }
        
        body {
            background-color: #030303;
            color: #e5e5e5;
            font-family: 'Inter', sans-serif;
            overflow: hidden;
        }

        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.1); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.2); }

        .glass {
            background: rgba(21, 21, 21, 0.7);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        
        .glass-strong {
            background: rgba(10, 10, 10, 0.95);
            backdrop-filter: blur(30px) saturate(200%);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .hero-input {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 0 0 1px rgba(245, 158, 11, 0), 0 20px 50px -10px rgba(0, 0, 0, 0.5);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .hero-input:focus-within {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(245, 158, 11, 0.3);
            box-shadow: 0 0 0 1px rgba(245, 158, 11, 0.2), 0 25px 60px -15px rgba(245, 158, 11, 0.15), 0 20px 50px -10px rgba(0, 0, 0, 0.5);
            transform: translateY(-2px);
        }

        .bottom-input {
            background: rgba(26, 26, 26, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }
        
        .bottom-input:focus-within {
            border-color: rgba(245, 158, 11, 0.4);
            box-shadow: 0 0 20px rgba(245, 158, 11, 0.1);
        }

        .message-appear {
            animation: messageAppear 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }
        
        @keyframes messageAppear {
            from { opacity: 0; transform: translateY(20px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .typing-wave { display: flex; gap: 3px; height: 20px; align-items: center; }
        .typing-bar {
            width: 4px;
            height: 8px;
            background: linear-gradient(to top, #f59e0b, #3b82f6);
            border-radius: 2px;
            animation: wave 1.2s ease-in-out infinite;
        }
        .typing-bar:nth-child(2) { animation-delay: 0.1s; }
        .typing-bar:nth-child(3) { animation-delay: 0.2s; }
        .typing-bar:nth-child(4) { animation-delay: 0.3s; }

        @keyframes wave {
            0%, 100% { transform: scaleY(1); }
            50% { transform: scaleY(2); }
        }

        .code-block {
            background: #0d0d0d;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            overflow: hidden;
            margin: 1rem 0;
        }
        .code-header {
            background: rgba(255, 255, 255, 0.03);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 0.75rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .code-content { padding: 1rem; overflow-x: auto; }

        .text-gradient {
            background: linear-gradient(135deg, #f59e0b 0%, #3b82f6 50%, #8b5cf6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            background-size: 200% 200%;
            animation: gradient 8s ease infinite;
        }
        
        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .aurora {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
            opacity: 0.4;
            background: 
                radial-gradient(circle at 20% 50%, rgba(245, 158, 11, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(59, 130, 246, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 20%, rgba(139, 92, 246, 0.1) 0%, transparent 50%);
            filter: blur(60px);
        }

        .sidebar-item {
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }
        .sidebar-item:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.1);
            transform: translateX(4px);
        }
        .sidebar-item.active {
            background: rgba(245, 158, 11, 0.1);
            border-color: rgba(245, 158, 11, 0.3);
        }

        .voice-wave { display: flex; align-items: center; gap: 2px; height: 24px; }
        .voice-bar {
            width: 3px;
            background: linear-gradient(to top, #f59e0b, #3b82f6);
            border-radius: 3px;
            transition: height 0.1s ease;
        }

        /* Error shake animation */
        .shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        .btn-primary {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(245, 158, 11, 0.3);
        }
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 30px rgba(245, 158, 11, 0.4);
        }
        .btn-primary:active { transform: translateY(0); }
        
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
    </style>
</head>
<body class="h-screen w-full antialiased selection:bg-amber-500/30 selection:text-amber-200">

    <div class="aurora"></div>

    <div class="flex h-full w-full relative">
        
        <!-- Sidebar -->
        <aside id="sidebar" class="w-80 h-full glass-strong flex flex-col transform -translate-x-full md:translate-x-0 transition-transform duration-300 absolute md:relative z-50 border-r border-white/5">
            <div class="p-5 border-b border-white/5 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-amber-500 via-orange-500 to-blue-600 flex items-center justify-center shadow-lg shadow-amber-500/20 animate-glow">
                        <i class="fas fa-bolt text-white text-lg"></i>
                    </div>
                    <div>
                        <h1 class="font-bold text-lg tracking-tight">Nexus AI</h1>
                        <p class="text-[10px] text-neutral-500 uppercase tracking-widest">Pro Edition</p>
                    </div>
                </div>
                <button onclick="chatApp.toggleSidebar()" class="md:hidden text-neutral-400 hover:text-white">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="p-4">
                <button onclick="chatApp.newChat()" class="w-full py-3 px-4 rounded-xl bg-white/5 hover:bg-white/10 border border-white/10 hover:border-amber-500/30 transition-all flex items-center gap-3 group">
                    <i class="fas fa-plus text-amber-500 group-hover:rotate-90 transition-transform duration-300"></i>
                    <span class="text-sm font-medium">New Conversation</span>
                </button>
            </div>

            <div class="flex-1 overflow-y-auto px-3 space-y-1" id="historyList"></div>

            <div class="p-4 border-t border-white/5 space-y-1">
                <button onclick="chatApp.toggleSettings()" class="sidebar-item w-full p-3 rounded-xl flex items-center gap-3 text-sm text-neutral-400 hover:text-white">
                    <i class="fas fa-cog w-5"></i>
                    <span>Settings</span>
                </button>
                <button onclick="chatApp.exportChat()" class="sidebar-item w-full p-3 rounded-xl flex items-center gap-3 text-sm text-neutral-400 hover:text-white">
                    <i class="fas fa-download w-5"></i>
                    <span>Export Chat</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col relative h-full overflow-hidden">
            
            <!-- Header -->
            <header class="h-16 glass border-b border-white/5 flex items-center justify-between px-6 z-40">
                <div class="flex items-center gap-4">
                    <button onclick="chatApp.toggleSidebar()" class="md:hidden p-2 -ml-2 rounded-lg hover:bg-white/5 text-neutral-400">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div id="modelBadge" class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-white/5 border border-white/10 text-xs font-medium">
                        <span class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></span>
                        <span class="text-neutral-300">GPT-4o</span>
                    </div>
                </div>

                <div class="flex items-center gap-2">
                    <button onclick="chatApp.clearChat()" class="p-2 rounded-lg hover:bg-white/5 text-neutral-400 hover:text-red-400 transition-colors" title="Clear Chat">
                        <i class="fas fa-trash-can"></i>
                    </button>
                </div>
            </header>

            <!-- Chat Container -->
            <div id="chatWrapper" class="flex-1 overflow-y-auto relative scroll-smooth">
                
                <!-- Hero Section -->
                <div id="heroSection" class="min-h-full flex flex-col items-center justify-center p-6 transition-all duration-500">
                    <div class="w-full max-w-3xl mx-auto space-y-8">
                        
                        <div class="text-center space-y-4 animate-float">
                            <div class="inline-flex items-center justify-center w-20 h-20 rounded-2xl bg-gradient-to-br from-amber-500 via-orange-500 to-blue-600 shadow-2xl shadow-amber-500/20 mb-4">
                                <i class="fas fa-robot text-4xl text-white"></i>
                            </div>
                            <h1 class="text-5xl md:text-6xl font-bold text-gradient tracking-tight">How can I help?</h1>
                            <p class="text-neutral-400 text-lg">Powered by Pollinations.ai â€¢ Free & Unlimited</p>
                        </div>

                        <!-- Fixed Input -->
                        <div class="relative">
                            <div class="hero-input rounded-2xl p-2 flex flex-col gap-2">
                                <textarea 
                                    id="heroInput" 
                                    rows="1"
                                    class="w-full bg-transparent border-0 px-4 py-4 text-lg text-white placeholder-neutral-500 resize-none focus:outline-none max-h-48 custom-scrollbar"
                                    placeholder="Ask anything..."
                                    onkeydown="chatApp.handleKeyDown(event)"
                                    oninput="chatApp.autoResize(this)"
                                ></textarea>
                                
                                <div class="flex items-center justify-between px-2 pb-1">
                                    <div class="flex items-center gap-1">
                                        <input type="file" id="fileInput" class="hidden" accept="image/*" onchange="chatApp.handleFile(event)">
                                        <button onclick="document.getElementById('fileInput').click()" class="p-2 rounded-lg hover:bg-white/10 text-neutral-400 hover:text-amber-400 transition-all" title="Upload Image">
                                            <i class="fas fa-image"></i>
                                        </button>
                                        
                                        <button onclick="chatApp.toggleCamera()" class="p-2 rounded-lg hover:bg-white/10 text-neutral-400 hover:text-blue-400 transition-all" title="Camera">
                                            <i class="fas fa-camera"></i>
                                        </button>
                                        
                                        <button onclick="chatApp.toggleVoice()" id="heroVoiceBtn" class="p-2 rounded-lg hover:bg-white/10 text-neutral-400 hover:text-red-400 transition-all" title="Voice Input">
                                            <i class="fas fa-microphone"></i>
                                        </button>
                                    </div>
                                    
                                    <button onclick="chatApp.sendMessage()" id="heroSendBtn" class="btn-primary px-6 py-2.5 rounded-xl text-white font-medium flex items-center gap-2 disabled:opacity-50">
                                        <span>Send</span>
                                        <i class="fas fa-paper-plane"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div id="filePreview" class="hidden mt-3 p-3 rounded-xl bg-white/5 border border-white/10 flex items-center gap-3 animate-scale-in">
                                <div class="w-10 h-10 rounded-lg bg-blue-500/20 flex items-center justify-center text-blue-500">
                                    <i class="fas fa-image"></i>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <p id="fileName" class="text-sm font-medium truncate">image.jpg</p>
                                    <p class="text-xs text-neutral-500">Click send to analyze</p>
                                </div>
                                <button onclick="chatApp.clearFile()" class="p-1.5 rounded-lg hover:bg-white/10 text-neutral-400">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Quick Actions -->
                        <div class="grid grid-cols-2 gap-3">
                            <button onclick="chatApp.quickPrompt('Explain quantum computing simply')" class="p-4 rounded-xl bg-white/5 border border-white/5 hover:border-amber-500/30 hover:bg-white/10 transition-all text-left">
                                <i class="fas fa-atom text-amber-500 mb-2 text-lg block"></i>
                                <span class="text-sm text-neutral-300">Explain Topics</span>
                            </button>
                            <button onclick="chatApp.quickPrompt('Write Python code for a calculator')" class="p-4 rounded-xl bg-white/5 border border-white/5 hover:border-blue-500/30 hover:bg-white/10 transition-all text-left">
                                <i class="fas fa-code text-blue-500 mb-2 text-lg block"></i>
                                <span class="text-sm text-neutral-300">Write Code</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Messages Area -->
                <div id="messagesArea" class="hidden max-w-4xl mx-auto p-4 md:p-8 space-y-6 pb-32">
                    <!-- Messages appear here -->
                </div>

                <!-- Bottom Input (Active Chat) -->
                <div id="bottomInputContainer" class="hidden fixed bottom-0 left-0 md:left-80 right-0 glass border-t border-white/10 p-4 z-30">
                    <div class="max-w-4xl mx-auto">
                        <div class="bottom-input rounded-2xl p-2 flex items-end gap-2">
                            <button onclick="chatApp.toggleCamera()" class="p-3 rounded-xl hover:bg-white/10 text-neutral-400 hover:text-blue-400 transition-colors">
                                <i class="fas fa-camera"></i>
                            </button>
                            
                            <textarea 
                                id="bottomInput"
                                rows="1"
                                class="flex-1 bg-transparent border-0 px-2 py-3 text-neutral-200 placeholder-neutral-500 resize-none focus:outline-none max-h-32 custom-scrollbar"
                                placeholder="Message Nexus AI..."
                                onkeydown="chatApp.handleKeyDown(event)"
                                oninput="chatApp.autoResize(this)"
                            ></textarea>
                            
                            <div class="flex items-center gap-1 pb-1">
                                <button onclick="chatApp.toggleVoice()" id="bottomVoiceBtn" class="p-3 rounded-xl hover:bg-white/10 text-neutral-400 hover:text-red-400 transition-colors">
                                    <i class="fas fa-microphone"></i>
                                </button>
                                <button onclick="chatApp.stopGeneration()" id="stopBtn" class="hidden p-3 rounded-xl bg-red-500/20 text-red-400 hover:bg-red-500/30">
                                    <i class="fas fa-stop"></i>
                                </button>
                                <button onclick="chatApp.sendMessage()" id="bottomSendBtn" class="btn-primary p-3 rounded-xl text-white disabled:opacity-50">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Camera Modal -->
        <div id="cameraModal" class="hidden fixed inset-0 z-50 bg-black/90 backdrop-blur-md flex items-center justify-center p-4">
            <div class="bg-dark-800 rounded-2xl w-full max-w-2xl overflow-hidden border border-white/10">
                <div class="p-4 border-b border-white/10 flex justify-between items-center">
                    <h3 class="font-semibold">Camera</h3>
                    <button onclick="chatApp.closeCamera()" class="text-neutral-400 hover:text-white">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="relative aspect-video bg-black">
                    <video id="cameraVideo" class="w-full h-full object-cover" autoplay playsinline></video>
                    <canvas id="cameraCanvas" class="hidden"></canvas>
                </div>
                <div class="p-4 flex justify-center gap-4">
                    <button onclick="chatApp.capturePhoto()" class="w-16 h-16 rounded-full bg-white flex items-center justify-center hover:scale-105 transition-transform border-4 border-dark-800">
                        <div class="w-12 h-12 rounded-full bg-white border-2 border-dark-800"></div>
                    </button>
                </div>
            </div>
        </div>

        <!-- Voice Visualizer -->
        <div id="voiceModal" class="hidden fixed inset-0 z-50 bg-black/80 backdrop-blur-md flex items-center justify-center">
            <div class="text-center space-y-6 p-8">
                <div class="flex justify-center gap-1 h-16 items-center">
                    <div class="w-1.5 bg-amber-500 rounded-full animate-[wave_1s_ease-in-out_infinite] h-4"></div>
                    <div class="w-1.5 bg-amber-500 rounded-full animate-[wave_1s_ease-in-out_0.1s_infinite] h-8"></div>
                    <div class="w-1.5 bg-amber-500 rounded-full animate-[wave_1s_ease-in-out_0.2s_infinite] h-12"></div>
                    <div class="w-1.5 bg-amber-500 rounded-full animate-[wave_1s_ease-in-out_0.3s_infinite] h-6"></div>
                    <div class="w-1.5 bg-amber-500 rounded-full animate-[wave_1s_ease-in-out_0.4s_infinite] h-10"></div>
                </div>
                <p class="text-neutral-400 animate-pulse">Listening...</p>
                <button onclick="chatApp.stopVoice()" class="px-6 py-2 rounded-full bg-white/10 hover:bg-white/20 text-sm transition-colors">
                    Stop
                </button>
            </div>
        </div>

        <!-- Settings Modal -->
        <div id="settingsModal" class="hidden fixed inset-0 z-50 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
            <div class="glass-strong rounded-2xl w-full max-w-lg p-6 space-y-6 border border-white/10">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold">Settings</h3>
                    <button onclick="chatApp.toggleSettings()" class="text-neutral-400 hover:text-white">
                        <i class="fas fa-times text-lg"></i>
                    </button>
                </div>

                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-neutral-400 mb-2">AI Model</label>
                        <select id="modelSelect" onchange="chatApp.changeModel(this.value)" class="w-full bg-dark-900 border border-white/10 rounded-xl px-4 py-3 text-sm focus:border-amber-500 focus:outline-none">
                            <option value="openai">GPT-4o (Best)</option>
                            <option value="mistral">Mistral Large</option>
                            <option value="llama">Llama 3.1</option>
                            <option value="claude">Claude 3</option>
                            <option value="gemini">Gemini</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-neutral-400 mb-2">System Prompt</label>
                        <textarea id="systemPrompt" rows="3" class="w-full bg-dark-900 border border-white/10 rounded-xl px-4 py-3 text-sm focus:border-amber-500 focus:outline-none" placeholder="You are a helpful assistant..."></textarea>
                    </div>

                    <div class="flex items-center justify-between p-4 rounded-xl bg-white/5 border border-white/5">
                        <span class="text-sm font-medium">Auto-Read Responses</span>
                        <button onclick="chatApp.toggleTTS()" id="ttsToggle" class="w-12 h-6 rounded-full bg-dark-600 relative transition-colors">
                            <span class="absolute left-1 top-1 w-4 h-4 rounded-full bg-white transition-transform"></span>
                        </button>
                    </div>
                </div>

                <button onclick="chatApp.saveSettings()" class="w-full py-3 rounded-xl btn-primary text-white font-semibold">
                    Save Changes
                </button>
            </div>
        </div>

        <div id="overlay" onclick="chatApp.closeSidebar()" class="hidden fixed inset-0 z-40 bg-black/50 backdrop-blur-sm md:hidden"></div>
    </div>

    <script>
        class ChatApp {
            constructor() {
                this.conversations = JSON.parse(localStorage.getItem('nexus_chats')) || [];
                this.currentId = null;
                this.isGenerating = false;
                this.currentFile = null;
                this.mediaStream = null;
                this.recognition = null;
                this.settings = JSON.parse(localStorage.getItem('nexus_settings')) || {
                    model: 'openai',
                    systemPrompt: 'You are Nexus AI, a helpful, harmless, and honest assistant.',
                    tts: false
                };
                
                this.init();
            }

            init() {
                this.loadSettings();
                this.renderHistory();
                this.setupVoice();
                
                // Ensure buttons are enabled
                this.setLoading(false);
                
                // Focus input
                setTimeout(() => {
                    const input = document.getElementById('heroInput');
                    if(input) input.focus();
                }, 100);
            }

            setupVoice() {
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    this.recognition = new SpeechRecognition();
                    this.recognition.continuous = false;
                    this.recognition.interimResults = true;
                    
                    this.recognition.onresult = (e) => {
                        const transcript = Array.from(e.results)
                            .map(r => r[0])
                            .map(r => r.transcript)
                            .join('');
                        
                        const hero = document.getElementById('heroInput');
                        const bottom = document.getElementById('bottomInput');
                        
                        if (!document.getElementById('heroSection').classList.contains('hidden')) {
                            hero.value = transcript;
                            this.autoResize(hero);
                        } else {
                            bottom.value = transcript;
                            this.autoResize(bottom);
                        }
                    };
                    
                    this.recognition.onend = () => {
                        document.getElementById('voiceModal').classList.add('hidden');
                    };
                }
            }

            setLoading(loading) {
                this.isGenerating = loading;
                const buttons = ['heroSendBtn', 'bottomSendBtn'];
                buttons.forEach(id => {
                    const btn = document.getElementById(id);
                    if (btn) btn.disabled = loading;
                });
                
                const stopBtn = document.getElementById('stopBtn');
                if (stopBtn) {
                    if (loading) stopBtn.classList.remove('hidden');
                    else stopBtn.classList.add('hidden');
                }
            }

            async sendMessage() {
                if (this.isGenerating) return;
                
                const isHero = !document.getElementById('heroSection').classList.contains('hidden');
                const inputEl = isHero ? document.getElementById('heroInput') : document.getElementById('bottomInput');
                const text = inputEl.value.trim();
                
                if (!text && !this.currentFile) {
                    inputEl.parentElement.classList.add('shake');
                    setTimeout(() => inputEl.parentElement.classList.remove('shake'), 500);
                    return;
                }
                
                this.setLoading(true);
                
                // Create chat if new
                if (!this.currentId) {
                    this.currentId = Date.now().toString();
                    this.conversations.unshift({
                        id: this.currentId,
                        title: text.substring(0, 40) || 'New Chat',
                        messages: [],
                        timestamp: Date.now()
                    });
                }
                
                const chat = this.conversations.find(c => c.id === this.currentId);
                
                // Add user message
                const userMsg = {
                    role: 'user',
                    content: text,
                    image: this.currentFile,
                    time: Date.now()
                };
                
                chat.messages.push(userMsg);
                this.saveChats();
                
                // Clear input
                inputEl.value = '';
                this.autoResize(inputEl);
                this.clearFile();
                
                // Switch to chat view
                this.switchToChatMode();
                this.renderMessages();
                
                // Get AI response
                await this.getAIResponse(chat);
            }

            async getAIResponse(chat) {
                const messages = chat.messages.map(m => ({
                    role: m.role,
                    content: m.content
                }));
                
                // Add system prompt
                messages.unshift({
                    role: 'system',
                    content: this.settings.systemPrompt
                });
                
                try {
                    // Create loading message
                    const loadingId = Date.now();
                    chat.messages.push({
                        id: loadingId,
                        role: 'assistant',
                        content: '',
                        loading: true
                    });
                    this.renderMessages();
                    
                    // API Call to Pollinations
                    const response = await fetch('https://text.pollinations.ai/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            messages: messages,
                            model: this.settings.model,
                            seed: Math.floor(Math.random() * 1000),
                            jsonMode: false
                        })
                    });
                    
                    if (!response.ok) throw new Error('API Error');
                    
                    const data = await response.text();
                    
                    // Remove loading and add real response
                    const loadingIndex = chat.messages.findIndex(m => m.id === loadingId);
                    if (loadingIndex > -1) {
                        chat.messages[loadingIndex] = {
                            role: 'assistant',
                            content: data,
                            time: Date.now()
                        };
                    }
                    
                    this.saveChats();
                    this.renderMessages();
                    this.renderHistory();
                    
                    // TTS if enabled
                    if (this.settings.tts) {
                        this.speak(data);
                    }
                    
                } catch (error) {
                    console.error('Error:', error);
                    
                    // Remove loading message
                    chat.messages = chat.messages.filter(m => !m.loading);
                    
                    // Add error message
                    chat.messages.push({
                        role: 'assistant',
                        content: 'Sorry, I encountered an error. Please check your internet connection and try again.',
                        error: true,
                        time: Date.now()
                    });
                    
                    this.renderMessages();
                    this.showError('Failed to get response. Please try again.');
                } finally {
                    this.setLoading(false);
                }
            }

            switchToChatMode() {
                document.getElementById('heroSection').classList.add('hidden');
                document.getElementById('messagesArea').classList.remove('hidden');
                document.getElementById('bottomInputContainer').classList.remove('hidden');
                
                // Scroll to bottom
                setTimeout(() => {
                    const wrapper = document.getElementById('chatWrapper');
                    wrapper.scrollTop = wrapper.scrollHeight;
                }, 100);
            }

            renderMessages() {
                const container = document.getElementById('messagesArea');
                const chat = this.conversations.find(c => c.id === this.currentId);
                
                if (!chat || chat.messages.length === 0) {
                    container.innerHTML = '';
                    return;
                }
                
                container.innerHTML = chat.messages.map((msg, idx) => {
                    if (msg.role === 'user') {
                        return `
                            <div class="message-appear flex justify-end mb-6" style="animation-delay: ${idx * 0.1}s">
                                <div class="max-w-[85%] md:max-w-[70%] space-y-2">
                                    ${msg.image ? `
                                        <div class="rounded-2xl overflow-hidden border border-white/10 mb-2">
                                            <img src="${msg.image}" class="max-h-64 w-auto object-cover">
                                        </div>
                                    ` : ''}
                                    <div class="bg-gradient-to-r from-amber-600 to-orange-600 rounded-2xl rounded-tr-sm px-5 py-3.5 text-white shadow-lg">
                                        ${msg.content}
                                    </div>
                                </div>
                            </div>
                        `;
                    } else {
                        if (msg.loading) {
                            return `
                                <div class="flex justify-start mb-6">
                                    <div class="flex gap-4 max-w-[90%]">
                                        <div class="w-8 h-8 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center flex-shrink-0 mt-1">
                                            <i class="fas fa-robot text-white text-xs"></i>
                                        </div>
                                        <div class="bg-dark-800 border border-white/10 rounded-2xl px-5 py-4">
                                            <div class="typing-wave">
                                                <div class="typing-bar"></div>
                                                <div class="typing-bar"></div>
                                                <div class="typing-bar"></div>
                                                <div class="typing-bar"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }
                        
                        return `
                            <div class="message-appear flex justify-start mb-6" style="animation-delay: ${idx * 0.1}s">
                                <div class="flex gap-4 max-w-[95%] md:max-w-[90%]">
                                    <div class="w-8 h-8 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center flex-shrink-0 mt-1 shadow-lg">
                                        <i class="fas fa-robot text-white text-xs"></i>
                                    </div>
                                    <div class="flex-1 space-y-2">
                                        <div class="bg-dark-800/80 border border-white/5 rounded-2xl px-5 py-4 prose prose-invert max-w-none ${msg.error ? 'border-red-500/30 text-red-200' : ''}">
                                            ${marked.parse(msg.content)}
                                        </div>
                                        <div class="flex gap-2 opacity-0 hover:opacity-100 transition-opacity">
                                            <button onclick="chatApp.copyText('${encodeURIComponent(msg.content)}')" class="text-xs text-neutral-500 hover:text-amber-400 px-2 py-1 rounded hover:bg-white/5">
                                                <i class="fas fa-copy mr-1"></i>Copy
                                            </button>
                                            <button onclick="chatApp.speak('${encodeURIComponent(msg.content)}')" class="text-xs text-neutral-500 hover:text-blue-400 px-2 py-1 rounded hover:bg-white/5">
                                                <i class="fas fa-volume-up mr-1"></i>Read
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                }).join('');
                
                // Highlight code
                container.querySelectorAll('pre code').forEach((block) => {
                    hljs.highlightElement(block);
                });
                
                // Scroll to bottom
                const wrapper = document.getElementById('chatWrapper');
                wrapper.scrollTop = wrapper.scrollHeight;
            }

            handleKeyDown(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    this.sendMessage();
                }
            }

            autoResize(textarea) {
                textarea.style.height = 'auto';
                textarea.style.height = Math.min(textarea.scrollHeight, 200) + 'px';
            }

            quickPrompt(text) {
                const hero = document.getElementById('heroInput');
                hero.value = text;
                this.autoResize(hero);
                this.sendMessage();
            }

            // File & Camera
            handleFile(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    this.currentFile = e.target.result;
                    document.getElementById('filePreview').classList.remove('hidden');
                    document.getElementById('fileName').textContent = file.name;
                };
                reader.readAsDataURL(file);
            }

            clearFile() {
                this.currentFile = null;
                document.getElementById('fileInput').value = '';
                document.getElementById('filePreview').classList.add('hidden');
            }

            async toggleCamera() {
                const modal = document.getElementById('cameraModal');
                if (modal.classList.contains('hidden')) {
                    try {
                        this.mediaStream = await navigator.mediaDevices.getUserMedia({ video: true });
                        document.getElementById('cameraVideo').srcObject = this.mediaStream;
                        modal.classList.remove('hidden');
                    } catch (err) {
                        this.showError('Camera access denied');
                    }
                } else {
                    this.closeCamera();
                }
            }

            closeCamera() {
                const modal = document.getElementById('cameraModal');
                if (this.mediaStream) {
                    this.mediaStream.getTracks().forEach(t => t.stop());
                }
                modal.classList.add('hidden');
            }

            capturePhoto() {
                const video = document.getElementById('cameraVideo');
                const canvas = document.getElementById('cameraCanvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                canvas.getContext('2d').drawImage(video, 0, 0);
                
                canvas.toBlob((blob) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        this.currentFile = e.target.result;
                        document.getElementById('filePreview').classList.remove('hidden');
                        document.getElementById('fileName').textContent = 'Camera Photo';
                        this.closeCamera();
                    };
                    reader.readAsDataURL(blob);
                });
            }

            // Voice
            toggleVoice() {
                if (!this.recognition) {
                    this.showError('Voice not supported in your browser');
                    return;
                }
                
                const modal = document.getElementById('voiceModal');
                if (modal.classList.contains('hidden')) {
                    this.recognition.start();
                    modal.classList.remove('hidden');
                } else {
                    this.stopVoice();
                }
            }

            stopVoice() {
                if (this.recognition) this.recognition.stop();
                document.getElementById('voiceModal').classList.add('hidden');
            }

            speak(text) {
                const utter = new SpeechSynthesisUtterance(decodeURIComponent(text));
                utter.rate = 1;
                utter.pitch = 1;
                window.speechSynthesis.speak(utter);
            }

            // Chat Management
            newChat() {
                this.currentId = null;
                this.clearFile();
                
                document.getElementById('heroSection').classList.remove('hidden');
                document.getElementById('messagesArea').classList.add('hidden');
                document.getElementById('bottomInputContainer').classList.add('hidden');
                document.getElementById('messagesArea').innerHTML = '';
                document.getElementById('heroInput').value = '';
                document.getElementById('bottomInput').value = '';
                
                this.renderHistory();
                if (window.innerWidth < 768) this.closeSidebar();
                
                setTimeout(() => document.getElementById('heroInput').focus(), 100);
            }

            loadChat(id) {
                this.currentId = id;
                this.renderMessages();
                this.switchToChatMode();
                this.renderHistory();
                this.closeSidebar();
            }

            deleteChat(id, e) {
                e.stopPropagation();
                this.conversations = this.conversations.filter(c => c.id !== id);
                this.saveChats();
                this.renderHistory();
                if (this.currentId === id) this.newChat();
            }

            clearChat() {
                if (this.currentId) {
                    const chat = this.conversations.find(c => c.id === this.currentId);
                    if (chat) {
                        chat.messages = [];
                        this.saveChats();
                        this.renderMessages();
                    }
                }
            }

            renderHistory() {
                const list = document.getElementById('historyList');
                list.innerHTML = this.conversations.map(conv => `
                    <button onclick="chatApp.loadChat('${conv.id}')" 
                            class="sidebar-item w-full p-3 rounded-xl flex items-center gap-3 mb-1 ${this.currentId === conv.id ? 'active' : ''}">
                        <i class="fas fa-message text-neutral-500 ${this.currentId === conv.id ? 'text-amber-500' : ''}"></i>
                        <div class="flex-1 min-w-0 text-left">
                            <p class="text-sm font-medium text-neutral-200 truncate">${conv.title}</p>
                            <p class="text-xs text-neutral-600">${new Date(conv.timestamp).toLocaleDateString()}</p>
                        </div>
                        <button onclick="chatApp.deleteChat('${conv.id}', event)" class="opacity-0 group-hover:opacity-100 p-1.5 hover:text-red-400">
                            <i class="fas fa-trash-alt text-xs"></i>
                        </button>
                    </button>
                `).join('');
            }

            saveChats() {
                localStorage.setItem('nexus_chats', JSON.stringify(this.conversations));
            }

            // Settings
            toggleSettings() {
                const modal = document.getElementById('settingsModal');
                modal.classList.toggle('hidden');
            }

            changeModel(model) {
                this.settings.model = model;
                document.getElementById('modelBadge').innerHTML = `
                    <span class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></span>
                    <span class="text-neutral-300">${model}</span>
                `;
            }

            toggleTTS() {
                this.settings.tts = !this.settings.tts;
                const btn = document.getElementById('ttsToggle');
                const dot = btn.querySelector('span');
                
                if (this.settings.tts) {
                    btn.classList.remove('bg-dark-600');
                    btn.classList.add('bg-amber-500');
                    dot.classList.add('translate-x-6');
                } else {
                    btn.classList.add('bg-dark-600');
                    btn.classList.remove('bg-amber-500');
                    dot.classList.remove('translate-x-6');
                }
            }

            loadSettings() {
                document.getElementById('modelSelect').value = this.settings.model;
                document.getElementById('systemPrompt').value = this.settings.systemPrompt;
                document.getElementById('modelBadge').innerHTML = `
                    <span class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></span>
                    <span class="text-neutral-300">${this.settings.model}</span>
                `;
                if (this.settings.tts) {
                    document.getElementById('ttsToggle').classList.remove('bg-dark-600');
                    document.getElementById('ttsToggle').classList.add('bg-amber-500');
                    document.getElementById('ttsToggle').querySelector('span').classList.add('translate-x-6');
                }
            }

            saveSettings() {
                this.settings.systemPrompt = document.getElementById('systemPrompt').value;
                localStorage.setItem('nexus_settings', JSON.stringify(this.settings));
                this.toggleSettings();
                this.showToast('Settings saved');
            }

            // Utils
            copyText(text) {
                navigator.clipboard.writeText(decodeURIComponent(text));
                this.showToast('Copied to clipboard');
            }

            exportChat() {
                if (!this.currentId) return;
                const chat = this.conversations.find(c => c.id === this.currentId);
                if (!chat) return;
                
                let md = `# ${chat.title}\n\n`;
                chat.messages.forEach(m => {
                    if (!m.loading) md += `**${m.role === 'user' ? 'User' : 'AI'}:** ${m.content}\n\n`;
                });
                
                const blob = new Blob([md], {type: 'text/markdown'});
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `chat-${chat.id}.md`;
                a.click();
            }

            toggleSidebar() {
                const sb = document.getElementById('sidebar');
                const ov = document.getElementById('overlay');
                
                if (sb.classList.contains('-translate-x-full')) {
                    sb.classList.remove('-translate-x-full');
                    ov.classList.remove('hidden');
                } else {
                    sb.classList.add('-translate-x-full');
                    ov.classList.add('hidden');
                }
            }

            closeSidebar() {
                document.getElementById('sidebar').classList.add('-translate-x-full');
                document.getElementById('overlay').classList.add('hidden');
            }

            stopGeneration() {
                this.setLoading(false);
                // In a real implementation, you'd abort the fetch here
            }

            showToast(msg) {
                const toast = document.createElement('div');
                toast.className = 'fixed top-20 left-1/2 -translate-x-1/2 px-6 py-3 rounded-full bg-amber-500/20 text-amber-400 border border-amber-500/20 backdrop-blur-md z-50 animate-fade-in';
                toast.textContent = msg;
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 3000);
            }

            showError(msg) {
                const toast = document.createElement('div');
                toast.className = 'fixed top-20 left-1/2 -translate-x-1/2 px-6 py-3 rounded-full bg-red-500/20 text-red-400 border border-red-500/20 backdrop-blur-md z-50 animate-fade-in';
                toast.textContent = msg;
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 3000);
            }
        }

        const chatApp = new ChatApp();
    </script>
</body>
</html>
